<!-- /*
 * Copyright (C) Contributors to the Suwayomi project
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/. */ -->
<template>
  <SearchBar></SearchBar>
  <q-btn
    flat
    class="q-ml-sm"
    round
    :text-color="$q.dark.isActive ? `white` : `dark`"
    icon="filter_list"
    @click="dialo = true"
  >
    <q-tooltip> Sort / Filter / Display </q-tooltip>
  </q-btn>
  <q-dialog v-model="dialo">
    <q-card>
      <q-card-section class="q-pa-none">
        <q-tabs v-model="tab" class="text-teal">
          <q-tab
            class="q-px-xl"
            name="filter"
            icon="filter_list"
            label="Filter"
          />
          <q-tab class="q-px-xl" name="sort" icon="sort" label="Sort" />
          <q-tab
            class="q-px-xl"
            name="display"
            icon="display_settings"
            label="Display"
          />
        </q-tabs>
      </q-card-section>

      <div v-if="tab == 'filter'">
        <q-card-section class="q-px-md q-pt-md q-pb-xs">
          <q-checkbox
            style="width: 100%"
            toggle-indeterminate
            v-model="unread"
            :dark="$q.dark.isActive"
            label="Unread"
            checked-icon="check_box"
            unchecked-icon="r_disabled_by_default"
            indeterminate-icon="check_box_outline_blank"
            keep-color
            size="lg"
            color="blue"
          />
        </q-card-section>
        <q-card-section class="q-px-md q-pt-xs q-pb-md">
          <q-checkbox
            style="width: 100%"
            toggle-indeterminate
            v-model="downloaded"
            label="Downloaded"
            :dark="$q.dark.isActive"
            checked-icon="check_box"
            unchecked-icon="r_disabled_by_default"
            indeterminate-icon="check_box_outline_blank"
            keep-color
            size="lg"
            color="green"
          />
        </q-card-section>
      </div>

      <div v-if="tab == 'sort'">
        <q-card-section class="q-px-md q-pt-md q-pb-xs">
          <q-checkbox
            style="width: 100%"
            checked-icon="arrow_upward"
            unchecked-icon="arrow_downward"
            indeterminate-icon="null"
            color="primary"
            keep-color
            v-model="leftToRead"
            label="By left to Read"
            :dark="$q.dark.isActive"
          />
        </q-card-section>
        <q-card-section class="q-px-md q-pt-xs q-pb-xs">
          <q-checkbox
            style="width: 100%"
            checked-icon="arrow_upward"
            unchecked-icon="arrow_downward"
            indeterminate-icon="null"
            color="primary"
            keep-color
            v-model="alphabetical"
            label="Alphabetical"
            :dark="$q.dark.isActive"
          />
        </q-card-section>
        <q-card-section class="q-px-md q-pt-xs q-pb-md">
          <q-checkbox
            style="width: 100%"
            checked-icon="arrow_upward"
            unchecked-icon="arrow_downward"
            indeterminate-icon="null"
            color="primary"
            keep-color
            v-model="ByID"
            label="By ID"
            :dark="$q.dark.isActive"
          />
        </q-card-section>
      </div>

      <div v-if="tab == 'display'">
        <q-item class="q-mx-lg q-pt-md q-pb-xs">
          <q-item-section thumbnail class="q-pr-sm">
            <q-icon name="display_settings" />
          </q-item-section>
          <q-item-section>
            <q-item-label>DISPLAY MODE</q-item-label>
          </q-item-section>
        </q-item>
        <q-card-section class="q-px-md q-py-xs">
          <q-radio v-model="disp" val="null" label="Compact grid" />
        </q-card-section>
        <q-card-section class="q-px-md q-py-xs">
          <q-radio v-model="disp" val="true" label="Comfortable grid" />
        </q-card-section>
        <q-card-section class="q-px-md q-pt-xs q-pb-md">
          <q-radio v-model="disp" val="false" label="list" />
        </q-card-section>
      </div>
    </q-card>
  </q-dialog>

  <q-btn
    flat
    round
    :text-color="$q.dark.isActive ? `white` : `dark`"
    icon="refresh"
    @click="update"
  >
    <q-tooltip> Update category </q-tooltip>
  </q-btn>
</template>

<script lang="ts">
import SearchBar from 'src/components/global/SearchBar.vue';
import { defineComponent, ref } from 'vue';
import Filters from './Filters';

export default defineComponent({
  name: 'libraryTopBar',
  components: { SearchBar },
  methods: {
    update() {
      this.$fetch('/api/v1/update/fetch', {
        method: 'POST',
        body: `categoryId=${this.$route.query['tab']}`
      });
    }
  },
  watch: {
    unread() {
      this.filters.setUnread(this.unread);
    },
    downloaded() {
      this.filters.setDownloaded(this.downloaded);
    },
    leftToRead() {
      this.filters.setLeftToRead(this.leftToRead);
      if (this.leftToRead != null) {
        this.alphabetical = null;
        this.ByID = null;
      }
    },
    alphabetical() {
      this.filters.setAlphabetical(this.alphabetical);
      if (this.alphabetical != null) {
        this.leftToRead = null;
        this.ByID = null;
      }
    },
    ByID() {
      this.filters.setByID(this.ByID);
      if (this.ByID != null) {
        this.alphabetical = null;
        this.leftToRead = null;
      }
    },
    disp() {
      if (this.disp == 'null') this.filters.setDisplay(null);
      else this.filters.setDisplay(this.disp == 'true');
    }
  },
  setup() {
    const filters = Filters();
    const unread = ref(<boolean | null>filters.unread.value);
    const downloaded = ref(<boolean | null>filters.downloaded.value);
    const leftToRead = ref(<boolean | null>filters.leftToRead.value);
    const alphabetical = ref(<boolean | null>filters.alphabetical.value);
    const ByID = ref(<boolean | null>filters.ByID.value);
    const disp = ref(<'null' | 'true' | 'false'>`${filters.Display.value}`);
    return {
      dialo: ref(false),
      tab: ref('filter'),
      unread,
      downloaded,
      leftToRead,
      alphabetical,
      ByID,
      disp,
      filters
    };
  }
});
</script>
